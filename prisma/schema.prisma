datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// Model สำหรับผู้ใช้งาน
model User {
  id        String   @id @default(cuid())
  clerkId   String   @unique // ใช้ Clerk ID หรือ ID จากระบบ Auth ของคุณ
  email     String   @unique
  name      String
  role      UserRole @default(OPERATOR)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ความสัมพันธ์: ผู้ใช้สร้างรายการอะไรบ้าง
  createdItems   ProcurementItem[]  @relation("CreatedBy")
  updatedItems   ProcurementItem[]  @relation("UpdatedBy")
  createdEntries MonthlyActualEntry[] @relation("RecordedBy")
}

enum UserRole {
  EXECUTIVE
  DEPT_HEAD
  GROUP_HEAD
  OPERATOR
}

// Model หลักสำหรับหมวดหมู่งบประมาณ (L1-L4)
model BudgetCategory {
  id           String   @id @default(cuid())
  categoryCode String   @unique // รหัสหมวดหมู่ (เช่น "REV", "EXP", "EXP-OP", "EXP-OP-MED")
  categoryName String   // ชื่อหมวดหมู่ (เช่น "รายรับ", "รายจ่าย", "ค่าเวชภัณฑ์มิใช่ยา")
  level        Int      // 1, 2, 3, หรือ 4
  categoryType String   // "revenue" หรือ "expense"
  icon         String?  // ชื่อ icon จาก lucide-react (เช่น "TrendingUp", "DollarSign")

  // ความสัมพันธ์แบบ Self-referencing (Tree structure)
  parentId String?
  parent   BudgetCategory? @relation("CategoryTree", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children BudgetCategory[] @relation("CategoryTree")

  // ความสัมพันธ์: หมวดหมู่นี้มีแผนงบประมาณอะไรบ้าง
  planData PlanFinancialData[]

  // ความสัมพันธ์: หมวดหมู่นี้ (L4) มีรายการจัดซื้ออะไรบ้าง
  procurementItems ProcurementItem[]

  // ความสัมพันธ์: หมวดหมู่นี้มีการบันทึกยอดใช้จริง (ที่ไม่ผูกกับ Item) อะไรบ้าง
  monthlyEntries MonthlyActualEntry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parentId])
}

// Model สำหรับรายการจัดซื้อ (L4 Items)
model ProcurementItem {
  id              String   @id @default(cuid())
  itemName        String   // ชื่อรายการ (เช่น "หน้ากากอนามัยทางการแพทย์")
  unitName        String   // หน่วยนับ (เช่น "กล่อง", "ชิ้น")
  inventory       Int      @default(0) // จำนวนคงคลัง (เพิ่มใหม่)
  procurementType String?  // วิธีจัดหา (เช่น "ประกวดราคา", "สอบราคา")

  // ความสัมพันธ์: รายการนี้อยู่ใต้หมวดหมู่ L4 ไหน
  categoryId String
  category   BudgetCategory @relation(fields: [categoryId], references: [id])

  // ความสัมพันธ์: รายการนี้ใครเป็นคนสร้าง/อัปเดต
  createdById String
  createdBy   User     @relation("CreatedBy", fields: [createdById], references: [id])
  updatedById String
  updatedBy   User     @relation("UpdatedBy", fields: [updatedById], references: [id])

  // ความสัมพันธ์: รายการนี้มียอดแผนเท่าไหร่
  planData PlanFinancialData[]

  // ความสัมพันธ์: รายการนี้มียอดใช้จริงเท่าไหร่
  monthlyEntries MonthlyActualEntry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId])
  @@index([createdById])
  @@index([updatedById])
}

// Model สำหรับ "แผน" งบประมาณ
model PlanFinancialData {
  id         String   @id @default(cuid())
  fiscalYear Int      // ปีงบประมาณ (เช่น 2567, 2568)
  planAmount Decimal  @default(0) // ยอดแผน (อาจจะเป็น L1, L2, L3, L4, หรือ Item)

  // ความสัมพันธ์: แผนนี้เป็นของหมวดหมู่ไหน (L1-L4)
  categoryId String
  category   BudgetCategory @relation(fields: [categoryId], references: [id])

  // ความสัมพันธ์: (Optional) แผนนี้เป็นของ Item ไหน
  procurementItemId String?
  procurementItem   ProcurementItem? @relation(fields: [procurementItemId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId])
  @@index([procurementItemId])
}

// Model สำหรับ "ยอดใช้จริง" (Actual)
model MonthlyActualEntry {
  id         String   @id @default(cuid())
  fiscalYear Int      // ปีงบประมาณ
  month      Int      // เดือน (1-12)
  entryDate  DateTime // วันที่บันทึกจริง
  amount     Decimal  // ยอดเงิน
  quantity   Int?     // จำนวน (ถ้ามี)
  notes      String?  // หมายเหตุ

  // ความสัมพันธ์: ยอดนี้เป็นของหมวดหมู่ไหน (L1-L4)
  categoryId String
  category   BudgetCategory @relation(fields: [categoryId], references: [id])

  // ความสัมพันธ์: (Optional) ยอดนี้เป็นของ Item ไหน
  procurementItemId String?
  procurementItem   ProcurementItem? @relation(fields: [procurementItemId], references: [id], onDelete: SetNull)

  // ความสัมพันธ์: ใครเป็นคนบันทึก
  recordedById String
  recordedBy   User     @relation("RecordedBy", fields: [recordedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId])
  @@index([procurementItemId])
  @@index([recordedById])
  @@index([fiscalYear, month])
}