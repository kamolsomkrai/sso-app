// prisma/schema.prisma

datasource db {
  provider = "postgresql" // (หรือ mysql, sqlserver)
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// -----------------------------------------------------------------
// 1. ผู้ใช้งานและปีงบประมาณ
// -----------------------------------------------------------------

enum UserRole {
  EXECUTIVE
  DEPT_HEAD
  GROUP_HEAD
  OPERATOR
}

// 1.1 (อัปเดตตามที่คุณขอ)
// ตาราง User จะเก็บข้อมูลจาก Provider โดยตรง
model User {
  // providerId ที่ได้จาก NextAuth / SSO
  providerId String @id @unique @db.VarChar(100)
  
  firstName String @db.VarChar(255)
  lastName  String @db.VarChar(255)
  position  String? @db.VarChar(255) // ตำแหน่ง
  role      UserRole @default(OPERATOR)

  // Audit Trail (ยังคงเชื่อมโยงเหมือนเดิม)
  createdItems        ProcurementItem[]   @relation("CreatedBy")
  updatedItems        ProcurementItem[]   @relation("UpdatedBy")
  createdEntries      MonthlyActualEntry[] @relation("CreatedBy")
  updatedEntries      MonthlyActualEntry[] @relation("UpdatedBy")
}

// (นำมาจาก SQL ของคุณ)
model FiscalYear {
  year_id     Int     @id @default(autoincrement())
  fiscal_year Int     @unique // 2569, 2570
  year_label  String  @db.VarChar(10)
  is_active   Boolean @default(false)
  is_planning Boolean @default(false)

  // Relations
  planData    PlanFinancialData[]
}

// -----------------------------------------------------------------
// 2. โครงสร้างงบประมาณ (L1-L4)
// (นำมาจาก SQL ของคุณ)
// -----------------------------------------------------------------

enum CategoryType {
  revenue
  expense
}

model BudgetCategory {
  category_id     String  @id @default(uuid())
  category_code   String  @unique @db.VarChar(50)
  category_name   String  @db.VarChar(500)
  category_type   CategoryType
  level           Int
  display_order   Int

  // Self-relation (Tree Structure)
  parent_id       String?
  parent          BudgetCategory?  @relation("CategoryTree", fields: [parent_id], references: [category_id])
  children        BudgetCategory[] @relation("CategoryTree")

  // Relations
  planData        PlanFinancialData[]
  
  // (เชื่อมกับ L4 Items)
  procurementItems ProcurementItem[] @relation("CategoryItems") 

  // (เชื่อมกับ L2 Requesting Dept)
  requestedItems   ProcurementItem[] @relation("RequestingDept")

  monthlyEntries  MonthlyActualEntry[] 
}

// -----------------------------------------------------------------
// 3. ข้อมูล "แผน" (Target)
// (นำมาจาก SQL ของคุณ)
// -----------------------------------------------------------------

model PlanFinancialData {
  plan_id     Int      @id @default(autoincrement())
  plan_amount Decimal  @db.Decimal(15, 2)
  plan_q1     Decimal? @db.Decimal(15, 2)
  plan_q2     Decimal? @db.Decimal(15, 2)
  plan_q3     Decimal? @db.Decimal(15, 2)
  plan_q4     Decimal? @db.Decimal(15, 2)

  // Relations
  category_id String
  category    BudgetCategory @relation(fields: [category_id], references: [category_id])

  fiscal_year Int
  fiscalYear  FiscalYear  @relation(fields: [fiscal_year], references: [fiscal_year])
  
  @@unique([category_id, fiscal_year])
}

// -----------------------------------------------------------------
// 4. "ราย LIST" (L4) และ ข้อมูลกรอกรายเดือน
// -----------------------------------------------------------------

// L4: "ราย list" (เช่น 'AWS WAF License')
model ProcurementItem {
  item_id   Int     @id @default(autoincrement())
  item_name String  @db.VarChar(500)
  details   String?

  // L2 Department (Requesting)
  requesting_dept_id String
  requestingDept     BudgetCategory @relation("RequestingDept", fields: [requesting_dept_id], references: [category_id])

  // L4 Budget Category
  category_id String
  category    BudgetCategory @relation("CategoryItems", fields: [category_id], references: [category_id])
  // --- 1.2 (อัปเดตตามที่คุณขอ) ---
  // เราจะเก็บแค่ "แผน" ของปีปัจจุบันเท่านั้น
  // ข้อมูลย้อนหลัง 5 ปี จะดึงจาก MonthlyActualEntry
  plan_amount       Decimal  @db.Decimal(12, 2) // แผนปีปัจจุบัน (จาก SQL total_price)
  procurement_code  String?  @db.VarChar(50) // (จาก SQL)
  unit              String?  @db.VarChar(50)  // (จาก SQL)
  quantity          Int?     // (จาก SQL)
  unit_price        Decimal? @db.Decimal(12, 2) // (จาก SQL)

  // --- Audit Trail ---
  createdAt   DateTime @default(now())
  createdById String
  createdBy   User     @relation("CreatedBy", fields: [createdById], references: [providerId]) //

  updatedAt   DateTime @updatedAt
  updatedById String
  updatedBy   User     @relation("UpdatedBy", fields: [updatedById], references: [providerId]) //

  // Relation
  monthlyEntries MonthlyActualEntry[] // ยอดใช้จริงรายเดือนของ Item นี้
}

// "ข้อมูลที่ผู้ใช้กรอกเข้ามารายเดือน"
// (นี่คือตารางที่ Dashboard จะใช้วาดกราฟ และ เปรียบเทียบ 5 ปี)
model MonthlyActualEntry {
  entry_id  Int     @id @default(autoincrement())
  amount    Decimal @db.Decimal(12, 2) // ยอดใช้จ่ายจริงที่กรอกเข้ามา

  fiscalYear Int    // เช่น 2569
  month      Int    // เช่น 10 (ต.ค.), 11 (พ.ย.)

  // เชื่อมโยงกลับไปยัง L4 (Item)
  procurement_item_id Int
  procurementItem     ProcurementItem @relation(fields: [procurement_item_id], references: [item_id])

  // (เพื่อความเร็วในการ Query L1-L3)
  category_id String
  category    BudgetCategory @relation(fields: [category_id], references: [category_id])

  // --- Audit Trail (ใครกรอก/แก้) ---
  createdAt   DateTime @default(now())
  createdById String // "ใครเป็นคนกรอก"
  createdBy   User     @relation("CreatedBy", fields: [createdById], references: [providerId]) //

  updatedAt   DateTime @updatedAt // "แก้ไขเมื่อไหร่"
  updatedById String // "ใครเป็นคนแก้ไข"
  updatedBy   User     @relation("UpdatedBy", fields: [updatedById], references: [providerId]) //

  notes       String? 
  
  @@index([fiscalYear, month])
  @@index([category_id])
}