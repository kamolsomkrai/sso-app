// schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  EXECUTIVE
  DEPT_HEAD
  GROUP_HEAD
  OPERATOR
}

enum CategoryType {
  REVENUE
  EXPENSE
}

enum ProcurementType {
  BIDDING
  QUOTATION
  DIRECT_PURCHASE
  EMERGENCY
}

model User {
  id String @id @default(cuid())

  // Provider ID Fields
  providerId   String? @unique @map("provider_id")
  cid          String? @db.VarChar(13)
  email        String?
  name         String?
  firstNameTh  String? @map("first_name_th")
  lastNameTh   String? @map("last_name_th")
  firstNameEn  String? @map("first_name_en")
  lastNameEn   String? @map("last_name_en")
  titleTh      String? @map("title_th")
  titleEn      String? @map("title_en")
  mobileNumber String? @map("mobile_number") @db.VarChar(10)

  // Organization Info
  organizationBusinessId   String? @map("org_business_id")
  organizationHcode        String? @map("org_hcode") @db.VarChar(9)
  organizationHnameTh      String? @map("org_hname_th")
  organizationPosition     String? @map("org_position")
  organizationPositionType String? @map("org_position_type")

  // Authentication & Authorization
  ialLevel   Float?   @map("ial_level")
  isHrAdmin  Boolean? @default(false) @map("is_hr_admin")
  isDirector Boolean? @default(false) @map("is_director")
  role       UserRole

  // Legacy field
  clerkId String? @unique @map("clerk_id")

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  lastLoginAt DateTime? @map("last_login_at")

  // Relations
  createdItems      ProcurementItem[]    @relation("UserCreatedItems")
  updatedItems      ProcurementItem[]    @relation("UserUpdatedItems")
  createdEntries    MonthlyActualEntry[] @relation("UserCreatedEntries")
  recordedEntries   MonthlyActualEntry[] @relation("UserRecordedEntries")
  auditLogs         AuditLog[]           @relation("UserAuditLogs")
  uploadedDocuments Document[]           @relation("UserDocuments")

  // Indexes
  @@index([providerId])
  @@index([cid])
  @@index([email])
  @@index([role])
  @@index([organizationHcode])
  @@index([createdAt])
  @@index([lastLoginAt])
  @@map("users")
}

model BudgetCategory {
  id String @id @default(cuid())

  // Category Identification
  categoryCode String       @unique @map("category_code") @db.VarChar(20)
  categoryName String       @map("category_name")
  level        Int
  categoryType CategoryType @map("category_type")
  icon         String?
  description  String?

  // Hierarchy
  parentId String?          @map("parent_id")
  parent   BudgetCategory?  @relation("CategoryChildren", fields: [parentId], references: [id])
  children BudgetCategory[] @relation("CategoryChildren")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  planData         PlanFinancialData[]
  actualEntries    MonthlyActualEntry[]
  procurementItems ProcurementItem[]

  // Indexes
  @@index([categoryCode])
  @@index([categoryType])
  @@index([level])
  @@index([parentId])
  @@index([categoryCode, level])
  @@index([categoryType, level])
  @@map("budget_categories")
}

model ProcurementItem {
  id String @id @default(cuid())

  // Item Information
  itemName        String          @map("item_name")
  unitName        String          @map("unit_name") @db.VarChar(20)
  inventory       Int             @default(0)
  procurementType ProcurementType @map("procurement_type")
  specifications  String?
  minStockLevel   Int?            @default(0) @map("min_stock_level")
  maxStockLevel   Int?            @map("max_stock_level")

  // Pricing
  unitPrice         Decimal? @map("unit_price") @db.Decimal(10, 2)
  lastPurchasePrice Decimal? @map("last_purchase_price") @db.Decimal(10, 2)

  // Relations
  categoryId String         @map("category_id")
  category   BudgetCategory @relation(fields: [categoryId], references: [id])

  createdById String @map("created_by_id")
  createdBy   User   @relation("UserCreatedItems", fields: [createdById], references: [id])

  updatedById String @map("updated_by_id")
  updatedBy   User   @relation("UserUpdatedItems", fields: [updatedById], references: [id])

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  planData      PlanFinancialData[]
  actualEntries MonthlyActualEntry[]
  documents     Document[]

  // Indexes
  @@index([itemName])
  @@index([categoryId])
  @@index([procurementType])
  @@index([inventory])
  @@index([createdById])
  @@index([updatedAt])
  @@map("procurement_items")
}

model PlanFinancialData {
  id String @id @default(cuid())

  // Financial Data
  fiscalYear Int     @map("fiscal_year")
  planAmount Decimal @map("plan_amount") @db.Decimal(15, 2)

  // Optional Relations
  categoryId String?         @map("category_id")
  category   BudgetCategory? @relation(fields: [categoryId], references: [id])

  procurementItemId String?          @map("procurement_item_id")
  procurementItem   ProcurementItem? @relation(fields: [procurementItemId], references: [id])

  // Metadata
  planVersion Int?      @default(1) @map("plan_version")
  isApproved  Boolean   @default(false) @map("is_approved")
  approvedAt  DateTime? @map("approved_at")
  notes       String?

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Indexes
  @@unique([fiscalYear, categoryId, procurementItemId, planVersion], name: "plan_unique_constraint")
  @@index([fiscalYear])
  @@index([categoryId])
  @@index([procurementItemId])
  @@index([fiscalYear, categoryId])
  @@index([fiscalYear, procurementItemId])
  @@index([isApproved])
  @@index([createdAt])
  @@map("plan_financial_data")
}

model MonthlyActualEntry {
  id String @id @default(cuid())

  // Entry Information
  fiscalYear Int      @map("fiscal_year")
  month      Int
  entryDate  DateTime @map("entry_date")
  amount     Decimal  @db.Decimal(15, 2)
  quantity   Int?
  notes      String?

  // Relations
  categoryId String         @map("category_id")
  category   BudgetCategory @relation(fields: [categoryId], references: [id])

  procurementItemId String?          @map("procurement_item_id")
  procurementItem   ProcurementItem? @relation(fields: [procurementItemId], references: [id])

  recordedById String @map("recorded_by_id")
  recordedBy   User   @relation("UserRecordedEntries", fields: [recordedById], references: [id])

  createdById String? @map("created_by_id")
  createdBy   User?   @relation("UserCreatedEntries", fields: [createdById], references: [id])

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  documents Document[]

  // Indexes
  @@unique([fiscalYear, month, categoryId, procurementItemId], name: "actual_entry_unique_constraint")
  @@index([fiscalYear])
  @@index([month])
  @@index([fiscalYear, month])
  @@index([categoryId])
  @@index([procurementItemId])
  @@index([recordedById])
  @@index([createdById])
  @@index([entryDate])
  @@index([createdAt])
  @@map("monthly_actual_entries")
}

model AuditLog {
  id String @id @default(cuid())

  // Action Information
  action      String
  entityType  String  @map("entity_type")
  entityId    String  @map("entity_id")
  oldValues   Json?   @map("old_values")
  newValues   Json?   @map("new_values")
  description String?

  // User who performed the action
  performedById String @map("performed_by_id")
  performedBy   User   @relation("UserAuditLogs", fields: [performedById], references: [id])

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  // Indexes
  @@index([action])
  @@index([entityType])
  @@index([entityId])
  @@index([performedById])
  @@index([createdAt])
  @@map("audit_logs")
}

model Document {
  id String @id @default(cuid())

  // File Information
  fileName String @map("file_name")
  filePath String @map("file_path")
  fileSize Int    @map("file_size")
  mimeType String @map("mime_type")

  // Relations
  procurementItemId String?          @map("procurement_item_id")
  procurementItem   ProcurementItem? @relation(fields: [procurementItemId], references: [id])

  monthlyEntryId String?             @map("monthly_entry_id")
  monthlyEntry   MonthlyActualEntry? @relation(fields: [monthlyEntryId], references: [id])

  // Metadata
  uploadedById String  @map("uploaded_by_id")
  uploadedBy   User    @relation("UserDocuments", fields: [uploadedById], references: [id])
  description  String?

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Indexes
  @@index([procurementItemId])
  @@ index([monthlyEntryId])
  @@index([uploadedById])
  @@index([createdAt])
  @@map("documents")
}

// ============================================
// KPI SYSTEM MODELS
// ============================================

enum KpiCalcLogic {
  GTE  // Greater Than or Equal
  LTE  // Less Than or Equal
  EQ0  // Equal to Zero
  EQT  // Equal to Target (text comparison)
}

enum KpiStatus {
  PASSED    // ผ่าน
  FAILED    // ไม่ผ่าน
  PENDING   // รอข้อมูล
  ERROR     // ข้อมูลผิดพลาด
}

model KpiIndicator {
  id   String @id @default(cuid())
  code String @unique @db.VarChar(10)
  name String

  // Relations
  kpis KpiMaster[]

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("kpi_indicators")
}

model KpiStrategy {
  id   String @id @default(cuid())
  code String @unique @db.VarChar(10)
  name String @db.Text

  // Relations
  objectives   KpiObjective[]
  plans        KpiPlan[]

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([code])
  @@map("kpi_strategies")
}

model KpiPlan {
  id   String @id @default(cuid())
  code String @unique @db.VarChar(10)
  name String @db.Text

  // Relations
  strategyId String       @map("strategy_id")
  strategy   KpiStrategy  @relation(fields: [strategyId], references: [id])

  objectives KpiObjective[]

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([strategyId])
  @@map("kpi_plans")
}

model KpiObjective {
  id   String @id @default(cuid())
  code String @unique @db.VarChar(10)
  name String @db.Text

  // Relations
  strategyId String?      @map("strategy_id")
  strategy   KpiStrategy? @relation(fields: [strategyId], references: [id])

  planId String?  @map("plan_id")
  plan   KpiPlan? @relation(fields: [planId], references: [id])

  kpis KpiMaster[]

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([strategyId])
  @@index([planId])
  @@map("kpi_objectives")
}

model KpiMaster {
  id String @id @default(cuid())

  // KPI Identification
  code String @unique @db.VarChar(20)
  name String @db.Text

  // Target Information
  targetText          String?      @map("target_text") @db.Text
  fiveYearTargetText  String?      @map("five_year_target_text") @db.Text
  fiveYearTargetValue Decimal?     @map("five_year_target_value") @db.Decimal(10, 2)
  fiveYearPlanPeriod  String?      @map("five_year_plan_period") @db.VarChar(20)
  
  // Calculation Logic
  calcLogic KpiCalcLogic @default(GTE) @map("calc_logic")

  // Ownership
  owner String? @db.VarChar(100)

  // Status
  isActive         Boolean  @default(true) @map("is_active")
  cumulativeValue  Decimal? @map("cumulative_value") @db.Decimal(10, 2)

  // Relations
  objectiveId String        @map("objective_id")
  objective   KpiObjective  @relation(fields: [objectiveId], references: [id])

  indicatorId String        @map("indicator_id")
  indicator   KpiIndicator  @relation(fields: [indicatorId], references: [id])

  quarterlyData KpiQuarterlyData[]
  annualData    KpiAnnualData[]

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Indexes
  @@index([code])
  @@index([objectiveId])
  @@index([indicatorId])
  @@index([isActive])
  @@map("kpi_master")
}

model KpiQuarterlyData {
  id String @id @default(cuid())

  // Period Information
  year    Int
  quarter Int @db.SmallInt // 1-4

  // Target and Result
  quarterlyTarget String? @map("quarterly_target") @db.Text
  result          String? @db.Text
  status          KpiStatus @default(PENDING)

  // Relations
  kpiId String    @map("kpi_id")
  kpi   KpiMaster @relation(fields: [kpiId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Unique constraint
  @@unique([kpiId, year, quarter])
  @@index([kpiId])
  @@index([year])
  @@index([status])
  @@map("kpi_quarterly_data")
}

model KpiAnnualData {
  id String @id @default(cuid())

  // Period Information
  year Int

  // Target and Result
  yearTarget Decimal? @map("year_target") @db.Decimal(10, 2)
  yearResult Decimal? @map("year_result") @db.Decimal(10, 2)

  // Relations
  kpiId String    @map("kpi_id")
  kpi   KpiMaster @relation(fields: [kpiId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Unique constraint
  @@unique([kpiId, year])
  @@index([kpiId])
  @@index([year])
  @@map("kpi_annual_data")
}
