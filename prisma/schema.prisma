// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgresql" // หรือ mysql/sqlite ตามที่คุณใช้
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// --- 1. Enums (การจำแนกประเภท) ---

enum UserRole {
  EXECUTIVE
  DEPT_HEAD
  GROUP_HEAD
  OPERATOR
}

enum CategoryType {
  revenue
  expense
}

enum BudgetType {
  TARGET
  EXPENSE
}

// --- 2. Models (ตารางข้อมูล) ---

model User {
  id           String @id @default(uuid())
  providerId   String @unique @map("provider_id") // ID จาก MOPH ID
  firstName    String @map("first_name")
  lastName     String @map("last_name")
  position     String?
  role         UserRole @default(OPERATOR)
  email        String?  @unique
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations (ความสัมพันธ์)
  createdItems      ProcurementItem[]    @relation("CreatedItems")
  updatedItems      ProcurementItem[]    @relation("UpdatedItems")
  createdEntries    MonthlyActualEntry[] @relation("CreatedEntries")
  varianceNotes     VarianceNote[]       @relation("AuthoredNotes")

  @@map("users")
}

model BudgetCategory {
  id           String @id @default(uuid())
  categoryId   String @unique @map("category_id") // ID ที่คุณกำหนดเอง (เช่น 'exp-op')
  categoryCode String @unique @map("category_code")
  categoryName String @map("category_name")
  categoryType CategoryType @map("category_type") // revenue หรือ expense
  level        Int

  // Self-relation (สำหรับโครงสร้าง Tree)
  parentId     String?              @map("parent_id")
  parent       BudgetCategory?      @relation("CategoryHierarchy", fields: [parentId], references: [categoryId], onDelete: NoAction, onUpdate: NoAction)
  children     BudgetCategory[]     @relation("CategoryHierarchy")

  // Relations (ความสัมพันธ์)
  planData         PlanFinancialData[]
  monthlyEntries   MonthlyActualEntry[]
  procurementItems ProcurementItem[]

  @@index([parentId])
  @@map("budget_categories")
}

model PlanFinancialData {
  id         String   @id @default(uuid())
  fiscalYear Int      @map("fiscal_year")
  planAmount Decimal  @default(0) @map("plan_amount") // งบประมาณ
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relation (ความสัมพันธ์)
  categoryId String         @map("category_id")
  category   BudgetCategory @relation(fields: [categoryId], references: [categoryId])

  @@index([categoryId])
  @@index([fiscalYear])
  @@map("plan_financial_data")
}

model ProcurementItem {
  id                String   @id @default(uuid())
  itemId            Int      @unique @default(autoincrement()) @map("item_id") // ID เดิม (ถ้ามี)
  itemName          String   @map("item_name")
  procurementCode   String?  @map("procurement_code")
  unit              String?
  quantity          Decimal?
  unitPrice         Decimal  @default(0) @map("unit_price")
  planAmount        Decimal  @default(0) @map("plan_amount")
  inventoryOnHand   Decimal  @default(0) @map("inventory_on_hand") // ยอดคงคลัง
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations (ความสัมพันธ์)
  categoryId      String         @map("category_id")
  category        BudgetCategory @relation(fields: [categoryId], references: [categoryId])

  createdById     String         @map("created_by_id")
  createdBy       User           @relation("CreatedItems", fields: [createdById], references: [providerId])

  updatedById     String         @map("updated_by_id")
  updatedBy       User           @relation("UpdatedItems", fields: [updatedById], references: [providerId])

  monthlyEntries  MonthlyActualEntry[]

  @@index([categoryId])
  @@index([createdById])
  @@index([updatedById])
  @@map("procurement_items")
}

model MonthlyActualEntry {
  id                String   @id @default(uuid())
  entryId           Int      @unique @default(autoincrement()) @map("entry_id") // ID เดิม (ถ้ามี)
  fiscalYear        Int      @map("fiscal_year")
  month             Int      // 1-12
  amount            Decimal  @default(0)
  createdAt         DateTime @default(now()) @map("created_at")

  // Relations (ความสัมพันธ์)
  // อาจจะผูกกับ L4 (Item) หรือ L3 (Category)
  categoryId        String?        @map("category_id")
  category          BudgetCategory?@relation(fields: [categoryId], references: [categoryId])

  procurementItemId String?        @map("procurement_item_id")
  procurementItem   ProcurementItem? @relation(fields: [procurementItemId], references: [id])

  userId            String         @map("user_id")
  user              User           @relation("CreatedEntries", fields: [userId], references: [providerId])

  @@index([categoryId])
  @@index([procurementItemId])
  @@index([userId])
  @@index([fiscalYear, month])
  @@map("monthly_actual_entries")
}

model VarianceNote {
  id        String   @id @default(uuid())
  year      Int
  quarter   Int
  note      String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  // Relation (ความสัมพันธ์)
  authorId  String   @map("author_id")
  author    User     @relation("AuthoredNotes", fields: [authorId], references: [providerId])

  @@index([authorId])
  @@index([year, quarter])
  @@map("variance_notes")
}

model Budget {
  id           String     @id @default(uuid())
  year         Int
  type         BudgetType // TARGET หรือ EXPENSE
  departmentId String?    @map("department_id")
  categoryId   String?    @map("category_id")
  month        Int        // 1-12
  amount       Decimal
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  @@index([year, month])
  @@map("budgets")
}